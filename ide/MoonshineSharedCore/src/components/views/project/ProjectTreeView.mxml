<?xml version="1.0" encoding="utf-8"?>
<!--
////////////////////////////////////////////////////////////////////////////////
//
//  Copyright (C) STARTcloud, Inc. 2015-2022. All rights reserved.
//
//  This program is free software: you can redistribute it and/or modify
//  it under the terms of the Server Side Public License, version 1,
//  as published by MongoDB, Inc.
//
//  This program is distributed in the hope that it will be useful,
//  but WITHOUT ANY WARRANTY; without even the implied warranty of
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
//  Server Side Public License for more details.
//
//  You should have received a copy of the Server Side Public License
//  along with this program. If not, see
//
//  http://www.mongodb.com/licensing/server-side-public-license
//
//  As a special exception, the copyright holders give permission to link the
//  code of portions of this program with the OpenSSL library under certain
//  conditions as described in each individual source file and distribute
//  linked combinations including the program with the OpenSSL library. You
//  must comply with the Server Side Public License in all respects for
//  all of the code used other than as permitted herein. If you modify file(s)
//  with this exception, you may extend this exception to your version of the
//  file(s), but you are not obligated to do so. If you do not wish to do so,
//  delete this exception statement from your version. If you delete this
//  exception statement from all source files in the program, then also delete
//  it in the license file.
//
////////////////////////////////////////////////////////////////////////////////
-->
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml"
		 xmlns:ui="actionScripts.ui.*"
		 xmlns:utils="actionScripts.utils.*"
		 implements="actionScripts.ui.IPanelWindow"
		 width="100%"
		 height="100%"
		 backgroundColor="0x444444"
		 verticalGap="0" xmlns:project="actionScripts.ui.project.*"
		 preinitialize="onPreinitialize()">

	<mx:Script>
		<![CDATA[
			import actionScripts.data.FileWrapperHierarchicalCollection;
			import actionScripts.events.GlobalEventDispatcher;
			import actionScripts.events.OpenFileEvent;
			import actionScripts.events.ProjectEvent;
			import actionScripts.factory.FileLocation;
			import actionScripts.locator.IDEModel;
			import actionScripts.plugin.workspace.WorkspacePlugin;
			import actionScripts.ui.LayoutModifier;
			import actionScripts.ui.project.ProjectViewHeader;
			import actionScripts.ui.renderers.FileWrapperHierarchicalItemRenderer;
			import actionScripts.ui.renderers.FileWrapperNativeContextMenuProvider;
			import actionScripts.utils.SharedObjectUtil;
			import actionScripts.utils.UtilsCore;
			import actionScripts.valueObjects.ConstantsCoreVO;
			import actionScripts.valueObjects.FileWrapper;
			import actionScripts.valueObjects.ProjectVO;

			import feathers.controls.TreeView;
			import feathers.data.ArrayCollection;
			import feathers.events.TreeViewEvent;
			import feathers.utils.DisplayObjectRecycler;

			import flash.display.DisplayObject;

			import mx.collections.ArrayCollection;
			import mx.collections.ArrayList;
			import mx.collections.Sort;
			import mx.collections.SortField;
			import mx.events.CollectionEvent;
			import mx.events.CollectionEventKind;
			import feathers.data.IFlatCollection;
			import actionScripts.valueObjects.WorkspaceVO;

			private static const PROPERTY_NAME_KEY:String = "name";
			private static const PROPERTY_NAME_KEY_VALUE:String = "nativePath";

			[Bindable]
			private var model:IDEModel = IDEModel.getInstance();

			private var dispatcher:GlobalEventDispatcher = GlobalEventDispatcher.getInstance();
	
			private var templateToCreate:FileLocation;
	
			private var _projects:mx.collections.ArrayCollection;
			private var _refreshActiveProjectTimeout:uint = uint.MAX_VALUE;

			[Bindable]
			private var _feathersTreeView:feathers.controls.TreeView;

			[Bindable]
			private var _feathersHeader:ProjectViewHeader;

			private var _activeFile:FileLocation;

			private var _ignoreTreeBranchChanges:Boolean = false;

			private var _oldActiveEditorFileWrapper:FileWrapper;

			public function get selectedItem():FileWrapper
			{
				if (!_feathersTreeView)
				{
					return null;
				}
				return FileWrapper(_feathersTreeView.selectedItem);
			}

			public function set selectedItem(value:FileWrapper):void
			{
				if (!_feathersTreeView)
				{
					return;
				}
				_feathersTreeView.selectedItem = findTreeViewItem(value);
			}

			public function get selectedItems():Array
			{
				if (!_feathersTreeView)
				{
					return null;
				}
				return _feathersTreeView.selectedItems;
			}

			public function set selectedItems(value:Array):void
			{
				if (!_feathersTreeView)
				{
					return;
				}
				if (value)
				{
					_feathersTreeView.selectedItems = value.map(function(item:FileWrapper, index:int, source:Array):FileWrapper
					{
						return findTreeViewItem(item);
					});
				}
				else
				{
					_feathersTreeView.selectedItems = null;
				}
			}

			[Bindable]
			public function get projects():mx.collections.ArrayCollection
			{
				return _projects;
			}
	
			public function set projects(value:mx.collections.ArrayCollection):void
			{
				_projects = value;
	
				// Scrape up all .projectFolders in here
				var pdirs:Array = [];
				for (var i:int = 0; i < value.length; i++)
				{
					var project:ProjectVO = value[i];
					pdirs.push(project.projectFolder);
				}

				model.selectedprojectFolders.removeAll();

				var dataSortField:SortField = new SortField("name", true);
				var dataSort:Sort = new Sort();
				dataSort.fields = [dataSortField];
				model.selectedprojectFolders.sort = dataSort;
				
				model.selectedprojectFolders.refresh();

				
			}

			public function get activeFile():FileLocation
			{
				return _activeFile;
			}

			public function set activeFile(value:FileLocation):void
			{
				if (_activeFile == value)
				{
					return;
				}
				_activeFile = value;

				if (_oldActiveEditorFileWrapper)
				{
					updateTreeViewItem(_oldActiveEditorFileWrapper);
				}
				if (_activeFile)
				{
					var fileWrapper:FileWrapper = new FileWrapper(_activeFile);
					updateTreeViewItem(fileWrapper);
					_oldActiveEditorFileWrapper = fileWrapper;
				}
				else
				{
					_oldActiveEditorFileWrapper = null;
				}
			}

			public function isItemVisible(item:Object):Boolean
			{
				if (!_feathersTreeView)
				{
					return false;
				}
				var itemRenderer:DisplayObject = _feathersTreeView.itemToItemRenderer(item);
				if (!itemRenderer)
				{
					return false;
				}
				// TODO: Check if item renderer is in view port (it might be
				// just outside of the view port and not actually visible)
				return true;
			}
			
			public function getParentItem(item:FileWrapper):FileWrapper
			{
				if (!_feathersTreeView || !item)
				{
					return null;
				}

				var location:Array = _feathersTreeView.dataProvider.locationOf(item);
				if (!location)
				{
					return null;
				}

				location.pop();

				if (location.length == 0)
				{
					return null;
				}

				return FileWrapper(_feathersTreeView.dataProvider.get(location));
			}

			public function scrollToItem(item:Object):void
			{
				if (!_feathersTreeView)
				{
					return;
				}

				var location:Array = _feathersTreeView.dataProvider.locationOf(item);
				if (!location)
				{
					return;
				}
				_feathersTreeView.scrollToLocation(location);
			}
			
			public function sortChildren(wrapper:FileWrapper):void
			{
				if (!wrapper) return;

				if (_feathersTreeView.dataProvider.isBranch(wrapper))
				{
					wrapper.sortChildren();
				}
				else
				{
					var location:Array = _feathersTreeView.dataProvider.locationOf(wrapper);
					if (!location) return;

					location.pop();
					if (location.length == 0) return;

					var parentWrapper:FileWrapper = _feathersTreeView.dataProvider.get(location) as FileWrapper;
					if (!parentWrapper) return;

					parentWrapper.sortChildren();
				}
			}

			public function expandItem(item:FileWrapper, open:Boolean):void
			{
				// get the actual FileWrapper instance used by the collection
				// because the one passed in may have the same path, but be a
				// different instance
				item = findTreeViewItem(item);
				if (item == null)
				{
					return;
				}
				
				if (!_feathersTreeView.dataProvider.isBranch(item))
				{
					// nothing to expand
					return;
				}

				var alreadyOpen:Boolean = _feathersTreeView.openBranches.indexOf(item) != -1;
				if (alreadyOpen != open)
				{
					var oldIgnoreTreeBranchChanges:Boolean = _ignoreTreeBranchChanges;
					_ignoreTreeBranchChanges = true;
					_feathersTreeView.toggleBranch(item, open);
					_ignoreTreeBranchChanges = oldIgnoreTreeBranchChanges;
					if (open)
					{
						// Flex Tree dispatches an add event when opening a
						// branch, but Feathers does not, so we force it here
						reopenPreviouslyClosedItems(CollectionEventKind.ADD, item.children.slice());
					}
				}
			}

			public function expandChildrenByName(itemPropertyName:String, childrenForOpen:Array):void
			{
				var location:Array = [];
				var childrenForOpenCount:int = childrenForOpen.length;
				for (var i:int = 0; i < childrenForOpenCount; i++)
				{
					var item:Object = childrenForOpen[i];
					var dataProviderCount:int = _feathersTreeView.dataProvider.getLength(location);
					for (var j:int = 0; j < dataProviderCount; j++)
					{
						location.push(j);
						var childForOpen:FileWrapper = FileWrapper(_feathersTreeView.dataProvider.get(location));

						var folderLastSeparator:int = childForOpen.nativePath.lastIndexOf(childForOpen.file.fileBridge.separator);
						var folder:String = childForOpen.nativePath.substring(folderLastSeparator + 1);

						if ((childForOpen.hasOwnProperty(itemPropertyName) && childForOpen[itemPropertyName] == item) || folder == item)
						{
							if (_feathersTreeView.dataProvider.isBranch(childForOpen)
									&& !_feathersTreeView.isBranchOpen(childForOpen))
							{
								saveItemForOpen(childrenForOpen);
								expandItem(childForOpen, true);
							}

							// break to the outer loop, and keep looking with a deeper location
							break;
						}
						location.pop();
					}
				}
			}

			public function refresh(dir:FileLocation, markAsDeletion:Boolean = false):void
			{
				var wrappersToSort:Vector.<FileWrapper> = new <FileWrapper>[];
				for each (var fw:FileWrapper in model.selectedprojectFolders)
				{
					if(ConstantsCoreVO.IS_AIR)
					{
						if((dir.fileBridge.nativePath + dir.fileBridge.separator).indexOf(fw.nativePath + dir.fileBridge.separator) != -1)
						{
							var tmpFW:FileWrapper = UtilsCore.findFileWrapperAgainstFileLocation(fw, dir);
							if(tmpFW)
							{
								if(_feathersTreeView.selectedItem)
								{
									var lastSelectedItem:FileWrapper = _feathersTreeView.selectedItem as FileWrapper;
									if(tmpFW.nativePath == lastSelectedItem.nativePath || lastSelectedItem.nativePath.indexOf(tmpFW.nativePath + tmpFW.file.fileBridge.separator) != -1)
										_feathersTreeView.selectedItem.isDeleting = markAsDeletion;
								}
								refreshItem(tmpFW);
								wrappersToSort.push(tmpFW);
							}
							break;
						}
					}
					else
					{
						tmpFW = UtilsCore.findFileWrapperAgainstFileLocation(fw, dir);
						refreshItem(tmpFW);
						wrappersToSort.push(tmpFW);
					}
				}

				while(wrappersToSort.length > 0)
				{
					tmpFW = wrappersToSort.shift();
					sortChildren(tmpFW);
					var children:Array = tmpFW.children;
					if (children)
					{
						var childCount:int = children.length;
						for(var i:int = 0; i < childCount; i++)
						{
							var child:FileWrapper = FileWrapper(children[i]);
							if (_feathersTreeView.dataProvider.isBranch(child) && _feathersTreeView.isBranchOpen(child))
							{
								// when calling refreshItem(), all children are
								// replaced with new FileWrapper instances, so their
								// children will need to be sorted too
								wrappersToSort.push(child);
							}
						}
					}
				}
			}
	
			public function refreshItem(fw:FileWrapper):void
			{
				var location:Array = _feathersTreeView.dataProvider.locationOf(fw);
				if (location == null)
				{
					return;
				}

				_feathersTreeView.dataProvider.updateAt(location);
				fw = _feathersTreeView.dataProvider.get(location) as FileWrapper;

				if (fw == null)
				{
					return;
				}

				var lastSelectedItem:FileWrapper = _feathersTreeView.selectedItem as FileWrapper;
				var lastSelectedLocation:Array = _feathersTreeView.selectedLocation;
				if (!_feathersTreeView.dataProvider.isBranch(fw))
				{
					if (lastSelectedItem != null && lastSelectedItem.nativePath == fw.nativePath)
					{
						_feathersTreeView.selectedItem = fw;
					}
					return;
				}
				var openItems:Array = _feathersTreeView.openBranches;
				var items:Array = [fw];
				var newItems:Array = [];
				do
				{
					for each(var item:FileWrapper in items)
					{
						updateChildrenAndOpenItems(item, openItems, newItems);
					}
					items.length = 0;
					var temp:Array = items;
					items = newItems;
					newItems = temp;
				}
				while(items.length > 0);

				var oldIgnoreTreeBranchChanges:Boolean = _ignoreTreeBranchChanges;
				_ignoreTreeBranchChanges = true;

				_feathersTreeView.openBranches = openItems;

				_ignoreTreeBranchChanges = oldIgnoreTreeBranchChanges;
	
				_feathersTreeView.selectedItem = findTreeViewItem(lastSelectedItem);
	
				// if still there has no selection to the tree
				if(!_feathersTreeView.selectedItem && lastSelectedItem && lastSelectedLocation && _feathersTreeView.dataProvider.contains(lastSelectedItem))
				{
					_feathersTreeView.selectedLocation = lastSelectedLocation;
				}
			}
	
			public function refreshActiveProject(projectFileWrapper:FileWrapper):void
			{
				if(!projectFileWrapper) return;
	
				var activeProject:ProjectVO = UtilsCore.getProjectFromProjectFolder(projectFileWrapper);
				if(activeProject)
				{
					if(model.activeProject != activeProject)
					{
						model.activeProject = activeProject;
						UtilsCore.setProjectMenuType(activeProject);
	
						dispatcher.dispatchEvent(new ProjectEvent(ProjectEvent.ACTIVE_PROJECT_CHANGED, activeProject));
					}
				}
			}
	
			public function getProjectBySelection(orByProjectPath:String = null):ProjectVO
			{
				if(!_feathersTreeView.selectedItem && !orByProjectPath) return null;
	
				for (var i:int; i < projects.length; i++)
				{
					if(!orByProjectPath)
					{
						if(FileWrapper(_feathersTreeView.selectedItem).projectReference.path == projects[i].folderPath) return projects[i];
					} else
					{
						if(orByProjectPath == projects[i].folderPath) return projects[i];
					}
				}
	
				return null;
			}
	
			private function onPreinitialize():void
			{
				_feathersHeader = new ProjectViewHeader();
				_feathersHeader.addEventListener("scrollFromSource", onScrollFromSource);
				_feathersHeader.addEventListener(Event.CLOSE, handleClose);

				_feathersTreeView = new feathers.controls.TreeView();
				_feathersTreeView.variant = feathers.controls.TreeView.VARIANT_BORDERLESS;
				_feathersTreeView.itemToText = function(item:Object):String {
					if ((item is ProjectVO)) {
						var project:ProjectVO = ProjectVO(item);
						return project.projectFolder.name;
					}
					if ((item is FileWrapper)) {
						var file:FileWrapper = FileWrapper(item);
						return file.name;
					}
					return null;
				}
				_feathersTreeView.allowMultipleSelection = true;
				_feathersTreeView.itemRendererRecycler = DisplayObjectRecycler.withFunction(function():DisplayObject {
					var itemRenderer:FileWrapperHierarchicalItemRenderer = new FileWrapperHierarchicalItemRenderer();
					itemRenderer.doubleClickEnabled = true;
					new FileWrapperNativeContextMenuProvider(itemRenderer);
					return itemRenderer;
				});
				_feathersTreeView.addEventListener(TreeViewEvent.BRANCH_OPENING, function(event:TreeViewEvent):void {
					if (_ignoreTreeBranchChanges) {
						// if a branch is opening programmatically from within
						// this class, ignore this event.
						// we're specifically interested in branches opening
						// outside of the control of this component, such as
						// from user interaction.
						return;
					}
					var fileWrapper:FileWrapper = event.state.data as FileWrapper;
					if (fileWrapper == null) {
						return;
					}
					refreshItem(fileWrapper);
				});
				_feathersTreeView.addEventListener(TreeViewEvent.BRANCH_OPEN, onTreeViewBranchOpen);
				_feathersTreeView.addEventListener(TreeViewEvent.BRANCH_CLOSE, onTreeViewBranchClose);
				_feathersTreeView.addEventListener(TreeViewEvent.ITEM_TRIGGER, fileSingleClickedInTreeView);
				_feathersTreeView.addEventListener(TreeViewEvent.ITEM_DOUBLE_CLICK, fileDoubleClickedInTreeView);

				setFeathersTreeViewData(model.selectedprojectFolders);
				model.selectedprojectFolders.addEventListener(CollectionEvent.COLLECTION_CHANGE, onSelectedProjectFoldersChange);

				setFeathersWorkspaceData(WorkspacePlugin.workspacesForViews);

				GlobalEventDispatcher.getInstance().addEventListener(
						WorkspacePlugin.EVENT_WORKSPACE_CHANGED,
						onWorkspaceChanged,
						false, 0, true
				);
				onWorkspaceChanged(null);
			}

			private function onWorkspaceChanged(event:Event):void
			{
				if (_feathersHeader.workspaces == null) {
					return;
				}
				for each (var workspace:WorkspaceVO in WorkspacePlugin.workspacesForViews.source)
				{
					if (workspace.label == ConstantsCoreVO.CURRENT_WORKSPACE)
					{
						_feathersHeader.selectedWorkspace = workspace;
						break;
					}
				}
			}

			private function onSelectedProjectFoldersChange(event:CollectionEvent):void
			{
				setFeathersTreeViewData(model.selectedprojectFolders);
			}

			private function setFeathersWorkspaceData(workspaces:mx.collections.ArrayList):void
			{
				var roots:Array = workspaces.source.slice();
				_feathersHeader.workspaces = new feathers.data.ArrayCollection(roots);
			}

			private function setFeathersTreeViewData(folders:mx.collections.ArrayCollection):void
			{
				var roots:Array = folders.source.slice();
				_feathersTreeView.dataProvider = new FileWrapperHierarchicalCollection(roots);
				reopenPreviouslyClosedItems(CollectionEventKind.RESET, model.selectedprojectFolders.source.slice());
			}

			private function updateChildrenAndOpenItems(fw:FileWrapper, openItems:Array, newItems:Array):void
			{
				var location:Array = _feathersTreeView.dataProvider.locationOf(fw);
				if (location == null)
				{
					return;
				}
				_feathersTreeView.dataProvider.updateAt(location);
				var length:int = _feathersTreeView.dataProvider.getLength(location);
				for (var i:int = 0; i < length; i++)
				{
					location.push(i);
					var child:FileWrapper = FileWrapper(_feathersTreeView.dataProvider.get(location));
					location.pop();
					for(var j:int = 0; j < openItems.length; j++)
					{
						var openItem:FileWrapper = openItems[j];
						if(openItem.nativePath == child.nativePath && openItem != child)
						{
							openItems[j] = child;
							newItems.push(child);
							break;
						}
					}
				}
			}
	
			private function setSelectedItem(fw:FileWrapper):void
			{
				var filew:FileWrapper;
				if(model.selectedprojectFolders.length > 1)
				{
					for (var i:int = 0; i < model.selectedprojectFolders.length; i++)
					{
						if(fw.nativePath.indexOf((model.selectedprojectFolders[i] as FileWrapper).nativePath) >= 0)
						{
							filew = model.selectedprojectFolders[i] as FileWrapper;
							break;
						}
					}
				}
				else
				{
					filew = model.selectedprojectFolders[0] as FileWrapper;
				}
	
				_feathersTreeView.selectedItem = findTreeViewItem(filew);
			}

			private function findTreeViewItem(itemToFind:FileWrapper):FileWrapper
			{
				if (itemToFind == null)
				{
					return null;
				}
				// locationOf does not check for the exact object. it checks for
				// an object that has the same native path. this allows us to
				// convert into the object that's actually in the data provider.
				var location:Array = _feathersTreeView.dataProvider.locationOf(itemToFind);
				if (location == null)
				{
					return null;
				}
				// this may return the item to find, or it might return a
				// different object that has the same native path
				return _feathersTreeView.dataProvider.get(location) as FileWrapper;
			}
	
			private function handleClose(event:Event):void
			{
				if(stage) LayoutModifier.removeFromSidebar(this);
			}
	
			private function fileSingleClickedInTreeView(event:TreeViewEvent):void
			{
				var item:FileWrapper = event.state.data as FileWrapper;
				refreshActiveProject(item);
			}
	
			private function fileDoubleClickedInTreeView(event:TreeViewEvent):void
			{
				var item:FileWrapper = event.state.data as FileWrapper;
				if(_feathersTreeView.dataProvider.isBranch(item))
				{
					callRefreshActiveProject(item);
					// don't ignore tree branch changes here!
					// this is a user interaction and the opened or closed
					// folder should be saved
					var open:Boolean = !_feathersTreeView.isBranchOpen(item);
					_feathersTreeView.toggleBranch(item, open);
					if (open)
					{
						// Flex Tree dispatches an add event when opening a
						// branch, but Feathers does not, so we force it here
						reopenPreviouslyClosedItems(CollectionEventKind.ADD, item.children.slice());
					}
				} 
				else
				{
					if(item.file.fileBridge.isDirectory || item.isWorking) return;

					callRefreshActiveProject(item);
					dispatcher.dispatchEvent(
							new OpenFileEvent(OpenFileEvent.OPEN_FILE, [item.file], -1, [item])
					);
				}

				/*
				 * @local
				 */
				function callRefreshActiveProject(value:FileWrapper):void
				{
					if (_refreshActiveProjectTimeout != uint.MAX_VALUE)
					{
						clearTimeout(_refreshActiveProjectTimeout);
						_refreshActiveProjectTimeout = uint.MAX_VALUE;
					}
					_refreshActiveProjectTimeout = setTimeout(function():void
					{
						_refreshActiveProjectTimeout = uint.MAX_VALUE;
						refreshActiveProject(value);
					}, 300);
				}
			}
	
			private function onTreeViewBranchOpen(event:TreeViewEvent):void
			{
				if (_ignoreTreeBranchChanges)
				{
					return;
				}
				saveItemForOpen(event.state.data);
			}
	
			private function onTreeViewBranchClose(event:TreeViewEvent):void
			{
				if (_ignoreTreeBranchChanges)
				{
					return;
				}
				removeFromOpenedItems(event.state.data);
			}
	
			private function onScrollFromSource(event:Event):void
			{
				dispatcher.dispatchEvent(new ProjectEvent(ProjectEvent.SCROLL_FROM_SOURCE));
			}

			private function reopenPreviouslyClosedItems(eventKind:String, items:Array):void
			{
				if (model.selectedprojectFolders == null || _feathersTreeView == null)
				{
					return;
				}

				var itemsCount:int = model.selectedprojectFolders.length;
				if (itemsCount > 0)
				{
					if (eventKind == CollectionEventKind.ADD || eventKind == CollectionEventKind.RESET)
					{
						itemsCount = items.length;
						if (eventKind == CollectionEventKind.RESET)
						{
							if (itemsCount == 0)
							{
								items = model.selectedprojectFolders.source.slice();
								itemsCount = items.length;
							}
						}

						if (itemsCount > 0)
						{
							setItemsAsOpen(items);
						}
					}
				}
			}

			private function saveItemForOpen(item:Object):void
			{
				SharedObjectUtil.saveProjectTreeItemForOpen(item, PROPERTY_NAME_KEY, PROPERTY_NAME_KEY_VALUE);
			}

			private function removeFromOpenedItems(item:Object):void
			{
				SharedObjectUtil.removeProjectTreeItemFromOpenedItems(item, PROPERTY_NAME_KEY, PROPERTY_NAME_KEY_VALUE);
			}

			private function setItemsAsOpen(items:Array):void
			{
				var cookie:SharedObject = SharedObjectUtil.getMoonshineIDEProjectSO("projectTree");
				if (!cookie) return;

				var projectTree:Array = cookie.data.projectTree;
				if (projectTree && items.length > 0)
				{
					var fileWrapper:FileWrapper = items.shift() as FileWrapper;
					if (fileWrapper != null && _feathersTreeView.dataProvider.isBranch(fileWrapper))
					{
						var open:Boolean = _feathersTreeView.openBranches.indexOf(fileWrapper) != -1;
						if (!open)
						{
							var hasItemForOpen:Boolean = projectTree.some(
									function hasSomeItemForOpen(itemForOpen:Object, index:int, arr:Array):Boolean {
										return itemForOpen.hasOwnProperty(fileWrapper[PROPERTY_NAME_KEY]) &&
												itemForOpen[fileWrapper[PROPERTY_NAME_KEY]] == fileWrapper[PROPERTY_NAME_KEY_VALUE];
									});
							if (hasItemForOpen)
							{
								//updateTreeViewItem(fileWrapper);
								// - or -
								// var location:Array = _feathersTreeView.dataProvider.locationOf(fileWrapper);
								// if (location != null) {
								// 	_feathersTreeView.dataProvider.updateAt(location);
								// }
								expandItem(fileWrapper, true);
								fileWrapper.sortChildren();
							}
						}
					}
					
					setItemsAsOpen(items);
				}
			}

			private function updateTreeViewItem(item:FileWrapper):void
			{
				item = findTreeViewItem(item);
				if (!item)
				{
					return;
				}
				var location:Array = _feathersTreeView.dataProvider.locationOf(item);
				if (!location)
				{
					return;
				}
				_feathersTreeView.dataProvider.updateAt(location);
			}
			
		]]>
	</mx:Script>

	<ui:FeathersUIWrapper
		feathersUIControl="{_feathersHeader}"
		width="100%"/>

	<ui:FeathersUIWrapper
			feathersUIControl="{_feathersTreeView}"
			width="100%" height="100%" minHeight="0"/>
</mx:VBox>